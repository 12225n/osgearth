<map>
    <libraries>osgEarthProcedural</libraries>

    <options>
        <terrain 
            progressive="true" 
            cast_shadows="true"
            priority_scale="1.5" />
        <cache 
            type="filesystem"
            path="cache" />
    </options>

    <xi:include href="osm_data.xml"/>
    <xi:include href="osm_water_data.xml"/>

    <TMSElevation name="ReadyMap 90m Elevation">
        <url>http://readymap.org/readymap/tiles/1.0.0/116/</url>
        <vdatum>egm96</vdatum>
    </TMSElevation>

    <mbtileselevation name="Nepal" enabled="false">
        <url>D:/data/demo/nepal/nepal.mbtiles</url>
    </mbtileselevation>

    <GroundCover name="Trees" max_range="4500" max_sse="1000" enabled="true">
        <category>trees</category>
        <cast_shadows>true</cast_shadows>
        <biomes_layer>Biomes</biomes_layer>
    </GroundCover>

    <Grass name="Grass" max_range="100" max_sse="35" enabled="true">
        <category>grass</category>
        <spacing>1.0</spacing>
    </Grass>

    <Wind name="Breeze">
        <winds>
            <wind type="directional" direction="1,0" speed="8 kts"/>
        </winds>
    </Wind>

    <contourmap altitude="-10"/>
    <!-- needs to be here or lifemap shader won't render properly...why? -->

    <lifemap name="Life Map" shared="true" min_level="11">
        <biomes_layer>Biomes</biomes_layer>
        <density_mask_layer>
            <xi:include href="osm_density_mask.xml"/>
        </density_mask_layer>
        <!-- <density_mask_layer>OSM Density Mask</density_mask_layer> -->
        <!--
        <landcover_layer>Copernicus</landcover_layer>
        <landcover_mappings>
            <mapping class="cropland"  density="0.8" moisture="0.5" rugged="0.1" temperature="0.5" />
            <mapping class="forest"    density="1.0" moisture="0.5" rugged="0.8" temperature="0.3" />
            <mapping class="savanna"   density="1.0" moisture="0.2" rugged="0.5" temperature="0.8" />
            <mapping class="grassland" density="1.0" moisture="0.8" rugged="0.0" temperature="0.4" />
            <mapping class="swamp"     density="0.5" moisture="0.8" rugged="0.3" temperature="0.6" />
            <mapping class="urban"     density="0.5" moisture="0.4" rugged="0.0" temperature="0.5" />
            <mapping class="desert"    density="0.1" moisture="0.0" rugged="0.6" temperature="0.9" />
            <mapping class="water"     density="0.0" moisture="1.0" rugged="0.0" temperature="0.0" />
            <mapping class="tundra"    density="0.1" moisture="1.0" rugged="0.6" temperature="0.5" />
            <mapping class="no-data"   density="0.0" moisture="0.0" rugged="0.0" temperature="0.5" />
        </landcover_mappings>
        -->

        <comment>to support the debug layers below</comment>
        <shared_sampler>LIFEMAP_TEX</shared_sampler>
        <shared_matrix>LIFEMAP_MAT</shared_matrix>
    </lifemap>

    <tmsimage name="DEBUG - Biome View" enabled="false">
        <cache_policy usage="none"/>
        <url>http://readymap.org/readymap/tiles/1.0.0/7/</url>
        <shader>
            <![CDATA[
                #version 430
                #pragma vp_name Biome View
                #pragma vp_entryPoint oe_splat_biome_view
                #pragma vp_location fragment_coloring
                #pragma vp_order 1.1
                
                #define BIOME 3
                
                const vec4 colors[7] = vec4[](
                    vec4(1,0,0,1),
                    vec4(1,1,0,1),
                    vec4(1,0,1,1),
                    vec4(0,1,1,1),
                    vec4(0,0,1,1),
                    vec4(1,0.5,0,1),
                    vec4(0,1,0,1)
                );
                
                uniform sampler2D LIFEMAP_TEX;
                uniform mat4 LIFEMAP_MAT;
                
                vec4 oe_layer_tilec;
                
                void oe_splat_biome_view(inout vec4 color)
                {               
                    ivec2 lifemap_xy = ivec2((LIFEMAP_MAT*oe_layer_tilec).st * 255.0);
                    int biomeid = int(texelFetch(LIFEMAP_TEX, lifemap_xy, 0)[BIOME] * 255.0);
                    //vec4 quad = texture(LIFEMAP_TEX, (LIFEMAP_MAT*oe_layer_tilec).st);
                    //int biomeid = int(quad[BIOME]*255.0);
                    color = colors[biomeid];
                }
            ]]>
        </shader>
    </tmsimage>

    <tmsimage name="DEBUG - LifeMap View" enabled="false">
        <cache_policy usage="none"/>
        <url>http://readymap.org/readymap/tiles/1.0.0/7/</url>
        <shader>
            <![CDATA[
                #version 430
                #pragma vp_name LifeMap View
                #pragma vp_entryPoint oe_splat_lifemap_view
                #pragma vp_location fragment_coloring
                
                #define DENSITY 0
                #define MOISTURE 1
                #define RUGGED 2
                #define BIOME 3                
                
                uniform float density_power = 1.0;
                uniform float moisture_power = 1.0;
                uniform float rugged_power = 1.0;
                
                uniform sampler2D LIFEMAP_TEX;
                uniform mat4 LIFEMAP_MAT;
                
                vec4 oe_layer_tilec;
                
                void oe_splat_lifemap_view(inout vec4 color)
                {               
                    vec4 quad = texture(LIFEMAP_TEX, (LIFEMAP_MAT*oe_layer_tilec).st);                    
                    color.g = quad[DENSITY] * density_power;
                    color.b = quad[MOISTURE] * moisture_power;
                    color.r = quad[RUGGED] * rugged_power;
                    color.a = 1;
                }
            ]]>
        </shader>
    </tmsimage>

    <TMSImage name="ReadyMap 15m Imagery" enabled="true" min_range="7500" attenuation_range="6000">
        <url>http://readymap.org/readymap/tiles/1.0.0/7/</url>
        <shader>
            <![CDATA[
            #pragma vp_entryPoint imageryDraw
            #pragma vp_location fragment
            void imageryDraw(inout vec4 color) {
                color.a = max(color.a, 0.15);
            }
          ]]>
        </shader>
    </TMSImage>

    <FeatureImage name="Road Surface" min_level="15" max_data_level="18" opacity="0.8">
        <profile>spherical-mercator</profile>
        <features>data:osm</features>
        <filters>
            <script>("highway" in feature.properties);</script>
        </filters>
        <styles>
            <style type="text/css">
                default {
                   stroke: #2f2f2f;
                   stroke-width: 10m;
                }
            </style>
        </styles>
    </FeatureImage>

    <xi:include href="osm_density_mask.xml"/>

    <Biomes name="Biomes">
        <cache_policy usage="none"/>
        <OGRFeatures name="Control Points">
            <url>D:/data/splat/biomes.shp</url>
        </OGRFeatures>
        <xi:include href="D:/data/splat/biomes.xml"/>
    </Biomes>

    <FeatureModel name="Political Boundaries" enabled="false">    
        <OGRFeatures name="world-data">
            <url>../data/world.shp</url>
        </OGRFeatures>
        <styles>
            <style type="text/css">
                world {
                   stroke:                   #ffff00;
                   stroke-width:             3px;
                   stroke-tessellation-size: 1km;
                   render-lighting:          false;
                   altitude-clamping:        terrain-drape;
                }            
            </style>
        </styles>
    </FeatureModel>

    <FeatureModel name="Biome Names" enabled="false">
        <cache_policy usage="none"/>
        <OGRFeatures url="../data/biomes.shp"/>
        <styles>
            <style>
                default {
                    text-content: [desc];
                    text-halo: #3f3f3f;
                    text-size: 28.0;
                    text-align: center_center;
                }
            </style>
        </styles>
    </FeatureModel>

    <xi:include href="osm_buildings.xml"/>

    <TerrainConstraint name="constraint:water" features="data:osm-water" remove_interior="false" min_level="12"/>

    <FeatureImage name="OSM Water" features="data:osm-water" min_level="12">
        <profile>spherical-mercator</profile>
        <styles>
            <style>
                water {
                    fill: #0f1f2f;
                }
            </style>
        </styles>
    </FeatureImage>

    <xi:include href="viewpoints.xml"/>
</map>
