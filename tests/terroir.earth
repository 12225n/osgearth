<map>
    <libraries>osgEarthProcedural</libraries>
    
    <options>
        <terrain progressive="true"/>
    </options>

    <TMSElevation name="ReadyMap 90m Elevation">
        <url>http://readymap.org/readymap/tiles/1.0.0/116/</url>
        <vdatum>egm96</vdatum>
    </TMSElevation>

    <xi:include href="viewpoints.xml"/>

    <mbtileselevation name="Nepal" enabled="false">
        <url>D:/data/demo/nepal/nepal.mbtiles</url>
    </mbtileselevation>

    <GroundCover name="Trees" max_range="7500" max_sse="100" enabled="false">
        <category>trees</category>
        <cast_shadows>true</cast_shadows>
        <biomes_layer>Biomes</biomes_layer>
        <mask_layer>OSM MASK</mask_layer>
    </GroundCover>

    <Grass name="Grass" max_range="100" max_sse="10" enabled="false">
        <category>grass</category>
        <mask_layer>OSM MASK</mask_layer>
    </Grass>

    <Wind name="Breeze">
        <winds>
            <wind type="directional" direction="1,0" speed="7 kts"/>
        </winds>
    </Wind>

    <contourmap/>
    <!-- needs to be here or lifemap shader won't render properly...why? -->

    <lifemap name="LifeMap" shared="true" min_level="10">
        <cache_policy usage="none"/>
        <biomes>Biomes</biomes>
        
        <comment>to support the debug layers below</comment>
        <shared_sampler>LIFEMAP_TEX</shared_sampler>
        <shared_matrix>LIFEMAP_MAT</shared_matrix>
    </lifemap>

    <tmsimage name="DEBUG - Biome View" enabled="false">
        <cache_policy usage="none"/>
        <url>http://readymap.org/readymap/tiles/1.0.0/7/</url>
        <shader>
            <![CDATA[
                #version 430
                #pragma vp_name Biome View
                #pragma vp_entryPoint oe_splat_biome_view
                #pragma vp_location fragment_coloring
                #pragma vp_order 1.1
                
                #define BIOME 3
                
                const vec4 colors[7] = vec4[](
                    vec4(1,0,0,1),
                    vec4(1,1,0,1),
                    vec4(1,0,1,1),
                    vec4(0,1,1,1),
                    vec4(0,0,1,1),
                    vec4(1,0.5,0,1),
                    vec4(0,1,0,1)
                );
                
                uniform sampler2D LIFEMAP_TEX;
                uniform mat4 LIFEMAP_MAT;
                
                vec4 oe_layer_tilec;
                
                void oe_splat_biome_view(inout vec4 color)
                {               
                    ivec2 lifemap_xy = ivec2((LIFEMAP_MAT*oe_layer_tilec).st * 255.0);
                    int biomeid = int(texelFetch(LIFEMAP_TEX, lifemap_xy, 0)[BIOME] * 255.0);
                    //vec4 quad = texture(LIFEMAP_TEX, (LIFEMAP_MAT*oe_layer_tilec).st);
                    //int biomeid = int(quad[BIOME]*255.0);
                    color = colors[biomeid];
                }
            ]]>
        </shader>
    </tmsimage>

    <tmsimage name="DEBUG - LifeMap View" enabled="false">
        <cache_policy usage="none"/>
        <url>http://readymap.org/readymap/tiles/1.0.0/7/</url>
        <shader>
            <![CDATA[
                #version 430
                #pragma vp_name LifeMap View
                #pragma vp_entryPoint oe_splat_lifemap_view
                #pragma vp_location fragment_coloring
                
                #define DENSITY 0
                #define MOISTURE 1
                #define RUGGED 2
                #define BIOME 3                
                
                uniform float density_power = 1.0;
                uniform float moisture_power = 1.0;
                uniform float rugged_power = 1.0;
                
                uniform sampler2D LIFEMAP_TEX;
                uniform mat4 LIFEMAP_MAT;
                
                vec4 oe_layer_tilec;
                
                void oe_splat_lifemap_view(inout vec4 color)
                {               
                    vec4 quad = texture(LIFEMAP_TEX, (LIFEMAP_MAT*oe_layer_tilec).st);                    
                    color.g = quad[DENSITY] * density_power;
                    color.b = quad[MOISTURE] * moisture_power;
                    color.r = quad[RUGGED] * rugged_power;
                    color.a = 1;
                }
            ]]>
        </shader>
    </tmsimage>

    <!-- 
    <xi:include href="osm_mask.xml"/>
    <xi:include href="osm_water.xml"/>
    <xi:include href="osm_roads.xml"/>
    <xi:include href="osm_buildings.xml"/>
    -->
    
    <TMSImage name="ReadyMap 15m Imagery" min_range="12500" attenuation_range="10000" enabled="true">
        <url>http://readymap.org/readymap/tiles/1.0.0/7/</url>
        <shader>
            <![CDATA[
            #pragma vp_entryPoint imageryDraw
            #pragma vp_location fragment
            void imageryDraw(inout vec4 color) {
                color.a = max(color.a, 0.4);
            }
          ]]>
        </shader>
    </TMSImage>

    <Biomes name="Biomes">
        <OGRFeatures name="Control Points">
            <url>D:/data/splat/biomes.shp</url>
        </OGRFeatures>
        <xi:include href="D:/data/splat/biomes.xml"/>
    </Biomes>

    <FeatureModel name="Country boundaries" enabled="false">    
        <OGRFeatures name="world-data">
            <url>../data/world.shp</url>
        </OGRFeatures>
        <styles>
            <style type="text/css">
                world {
                   stroke:                   #ffff00;
                   stroke-width:             3px;
                   stroke-tessellation-size: 1km;
                   render-lighting:          false;
                   altitude-clamping:        terrain-drape;        
                }            
            </style>
        </styles>
    </FeatureModel>

    <FeatureModel name="Biome Names" enabled="false">
        <OGRFeatures url="../data/biomes.shp"/>
        <styles>
            <style>
                default {
                    text-content: [desc];
                    text-halo: #3f3f3f;
                    text-size: 28.0;
                    text-align: center_center;
                }
            </style>
        </styles>
    </FeatureModel>
</map>
